name: supabase-function-logs

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Supabase environment to query (e.g. prod, stage, dev)"
        required: false
        default: "prod"
      since:
        description: "How far back to pull logs (e.g. 1h, 6h, 24h, 7d)"
        required: false
        default: "24h"
      limit:
        description: "Maximum number of log entries to return"
        required: false
        default: "400"
      function:
        description: "Optional substring filter (function name, request ID, etc.)"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  fetch-logs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1

      - name: Fetch Supabase function logs
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          FUNCTION_FILTER: ${{ inputs.function }}
          LOG_SINCE: ${{ inputs.since }}
          LOG_LIMIT: ${{ inputs.limit }}
          LOG_ENV: ${{ inputs.environment }}
        run: |
          set -euo pipefail

          if [ -z "${SUPABASE_ACCESS_TOKEN:-}" ] || [ -z "${SUPABASE_PROJECT_ID:-}" ]; then
            echo "SUPABASE_ACCESS_TOKEN and SUPABASE_PROJECT_ID secrets are required to fetch logs." >&2
            exit 1
          fi

          SEARCH_ARG=()
          if [ -n "${FUNCTION_FILTER:-}" ]; then
            SEARCH_ARG+=(--search "$FUNCTION_FILTER")
          fi

          supabase functions logs \
            --project-ref "$SUPABASE_PROJECT_ID" \
            --env "$LOG_ENV" \
            --since "$LOG_SINCE" \
            --limit "$LOG_LIMIT" \
            "${SEARCH_ARG[@]}" \
            | tee supabase-function-logs.txt

      - name: Upload logs artifact
        uses: actions/upload-artifact@v4
        with:
          name: supabase-function-logs
          path: supabase-function-logs.txt
          retention-days: 7
